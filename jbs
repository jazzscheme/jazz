#!/bin/sh

if [ -n "${GAMBIT_DISTR_REPO:+x}" ]; then
	REPO=$GAMBIT_DISTR_REPO
else
	REPO="http://git/gambit-distr"
fi

if [ "$1" = init ]; then
	PREFIX=$(PWD)/gambit/install
	[ -d gambit ] && rm -rf gambit
	mkdir gambit &&
	cd gambit &&
	git clone $REPO distr &&
	cd distr &&
	./configure --prefix=$PREFIX --enable-single-host &&
	make -j2 &&
	make install &&
	exit 0 || exit 1
fi

if [ "$1" = update ]; then
	cd gambit/distr &&
	git pull &&
	make -j2 &&
	make install &&
	exit 0 || exit 1
fi
	
if [ -n "${GSC_JAZZ:+x}" ]; then
	if [ -f $GSC_JAZZ ]; then
		exec $GSC_JAZZ "$@"
	else
		echo "Gambit-Jazz compiler $GSC_JAZZ which is set in GSC_JAZZ is non-existant"
		exit 1
	fi
fi

[ -f gambit/install/bin/gsc ] && exec gambit/install/bin/gsc "$@"

echo "GSC_JAZZ not set and local Gambit-Jazz not initialized. Fallback on system gambit-c. Run jbs init to setup local Gambit-Jazz\n"

if [[ $(uname) == *MINGW* ]]; then
	GSC=gsc
else
	GSC=gsc-script
fi

if ! type -p $GSC &> /dev/null ; then
	echo "Gambit-c compiler $GSC cannot be found in PATH"
	exit 1
fi

exec $GSC "$@"