;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; GStreamer Foreign
;;;
;;;  The contents of this file are subject to the Mozilla Public License Version
;;;  1.1 (the "License"); you may not use this file except in compliance with
;;;  the License. You may obtain a copy of the License at
;;;  http://www.mozilla.org/MPL/
;;;
;;;  Software distributed under the License is distributed on an "AS IS" basis,
;;;  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;;  for the specific language governing rights and limitations under the
;;;  License.
;;;
;;;  The Original Code is JazzScheme.
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 1996-2015
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):
;;;
;;;  Alternatively, the contents of this file may be used under the terms of
;;;  the GNU General Public License Version 2 or later (the "GPL"), in which
;;;  case the provisions of the GPL are applicable instead of those above. If
;;;  you wish to allow use of your version of this file only under the terms of
;;;  the GPL, and not to allow others to use your version of this file under the
;;;  terms of the MPL, indicate your decision by deleting the provisions above
;;;  and replace them with the notice and other provisions required by the GPL.
;;;  If you do not delete the provisions above, a recipient may use your version
;;;  of this file under the terms of any one of the MPL or the GPL.
;;;
;;;  See www.jazzscheme.org for details.


(module protected jazz.gstreamer.foreign jazz


(import (jazz.foreign)
        (jazz.platform.types))


(c-include "<gst/gst.h>")
(c-include "<glib.h>")


;;;
;;;; GLib
;;;


(c-type gint       int)
(c-type guint      uint)
(c-type gulong     ulong)
(c-type gboolean   gint)
(c-type gpointer   void*)
(c-type GMainLoop  (native "GMainLoop"))
(c-type GMainLoop* (pointer GMainLoop GMainLoop*))


(c-declare jazz.gstreamer.foreign #/C/
static void
on_pad_added (GstElement *element,
              GstPad     *pad,
              gpointer    data)
{
  GstPad *sinkpad;
  GstElement *decoder = (GstElement *) data;

  /* We can now link this pad with the vorbis-decoder sink pad */
  g_print ("Dynamic pad created, linking demuxer/decoder\n");

  sinkpad = gst_element_get_static_pad (decoder, "sink");

  gst_pad_link (pad, sinkpad);

  gst_object_unref (sinkpad);
}

static gulong g_signal_connect_aux(gpointer instance, char* signal, gpointer data)
{
    return g_signal_connect(instance, signal, G_CALLBACK(on_pad_added), data);
}
//#)


(c-external (g_main_loop_new NULL FALSE) GMainLoop*)
(c-external (g_main_loop_run GMainLoop*) void)
(c-external (g_object_set (call G_OBJECT GstElement*) char-string char-string NULL) void)
(c-external (gst_object_unref gpointer) void)
(c-external (g_signal_connect gpointer char-string gpointer) gulong "g_signal_connect_aux")


;;;
;;;; GStreamer
;;;


(c-enumerant GST_STATE_PLAYING)
(c-enumerant GST_CLOCK_TIME_NONE)
(c-enumerant GST_MESSAGE_ERROR)
(c-enumerant GST_MESSAGE_EOS)


(c-type GstClockTime         int64)
(c-type GstStateChangeReturn enum)
(c-type GstState             enum)
(c-type GstMessageType       enum)


(c-type GstElement   (native "GstElement"))
(c-type GstElement*  (pointer GstElement GstElement*))
(c-type GstBin       (native "GstBin"))
(c-type GstBin*      (pointer GstBin GstBin*))
(c-type GstPipeline  (native "GstPipeline"))
(c-type GstPipeline* (pointer GstPipeline GstPipeline*))
(c-type GstBus       (native "GstBus"))
(c-type GstBus*      (pointer GstBus GstBus*))
(c-type GstMessage   (native "GstMessage"))
(c-type GstMessage*  (pointer GstMessage GstMessage*))


(c-declare jazz.gstreamer.foreign #/C/
static gboolean
bus_call (GstBus     *bus,
          GstMessage *msg,
          gpointer    data)
{
  GMainLoop *loop = (GMainLoop *) data;

  switch (GST_MESSAGE_TYPE (msg)) {

    case GST_MESSAGE_EOS:
      g_print ("End of stream\n");
      g_main_loop_quit (loop);
      break;

    case GST_MESSAGE_ERROR: {
      gchar  *debug;
      GError *error;

      gst_message_parse_error (msg, &error, &debug);
      g_free (debug);

      g_printerr ("Error: %s\n", error->message);
      g_error_free (error);

      g_main_loop_quit (loop);
      break;
    }
    default:
      break;
  }

  return TRUE;
}

static guint gst_bus_add_watch_aux(GstBus* bus, gpointer user_data)
{
    gst_bus_add_watch(bus, bus_call, user_data);
}
//#)


(c-external (gst_init NULL NULL) void)
(c-external (gst_parse_launch char-string NULL) GstElement*)
(c-external (gst_element_set_state GstElement* GstState) GstStateChangeReturn)
(c-external (gst_element_get_bus GstElement*) GstBus*)
(c-external (gst_element_factory_make char-string char-string) GstElement*)
(c-external (gst_element_link GstElement* GstElement*) gboolean)
(c-external (gst_bus_add_watch GstBus* gpointer) guint "gst_bus_add_watch_aux")
(c-external (gst_bus_timed_pop_filtered GstBus* GstClockTime GstMessageType) GstMessage*)
(c-external (gst_bin_add (call GST_BIN GstElement*) GstElement*) gboolean)
(c-external (gst_pipeline_new char-string) GstElement*)
(c-external (gst_pipeline_get_bus (call GST_PIPELINE GstElement*)) GstBus*))
