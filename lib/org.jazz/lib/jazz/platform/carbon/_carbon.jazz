;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; Carbon
;;;
;;;  The contents of this file are subject to the Mozilla Public License Version
;;;  1.1 (the "License"); you may not use this file except in compliance with
;;;  the License. You may obtain a copy of the License at
;;;  http://www.mozilla.org/MPL/
;;;
;;;  Software distributed under the License is distributed on an "AS IS" basis,
;;;  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;;  for the specific language governing rights and limitations under the
;;;  License.
;;;
;;;  The Original Code is JazzScheme.
;;;
;;;  The Initial Developer of the Original Code is Jeremie Lasalle Ratelle.
;;;  Portions created by the Initial Developer are Copyright (C) 1996-2007
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):
;;;
;;;  Alternatively, the contents of this file may be used under the terms of
;;;  the GNU General Public License Version 2 or later (the "GPL"), in which
;;;  case the provisions of the GPL are applicable instead of those above. If
;;;  you wish to allow use of your version of this file only under the terms of
;;;  the GPL, and not to allow others to use your version of this file under the
;;;  terms of the MPL, indicate your decision by deleting the provisions above
;;;  and replace them with the notice and other provisions required by the GPL.
;;;  If you do not delete the provisions above, a recipient may use your version
;;;  of this file under the terms of any one of the MPL or the GPL.
;;;
;;;  See www.jazzscheme.org for details.(library jazz.platform.x11 jazz


(library jazz.platform.carbon jazz


(import (jazz.platform.types)
        (jazz.platform.carbon.carbon-types))


(c-include "<Carbon/Carbon.h>")


;;;
;;;; Basic Constants
;;;


(constant noErr 0)


;;;
;;;; Window Class
;;;


(constant kDocumentWindowClass 6)
(constant kPlainWindowClass    13)


;;;
;;;; Window Attributes
;;;

(constant kWindowNoAttributes               0)
(constant kWindowCloseBoxAttribute          (arithmetic-shift 1 0))
(constant kWindowHorizontalZoomAttribute    (arithmetic-shift 1 1))
(constant kWindowVerticalZoomAttribute      (arithmetic-shift 1 2))
(constant kWindowFullZoomAttribute          (bitwise-ior kWindowVerticalZoomAttribute
 kWindowHorizontalZoomAttribute))
(constant kWindowCollapseBoxAttribute       (arithmetic-shift 1 3))
(constant kWindowResizableAttribute         (arithmetic-shift 1 4))
(constant kWindowStandardDocumentAttributes (bitwise-ior kWindowCloseBoxAttribute
 kWindowFullZoomAttribute
 kWindowCollapseBoxAttribute
 kWindowResizableAttribute))
(constant kWindowCompositingAttribute       (arithmetic-shift 1 19))
(constant kWindowStandardHandlerAttribute   (arithmetic-shift 1 25))
(constant kWindowLiveResizeAttribute        (arithmetic-shift 1 28))

;;;
;;;; Event Classes
;;;


(constant kEventClassWindow   ((c-function () OSType "___result = kEventClassWindow;")))
(constant kEventClassMouse    ((c-function () OSType "___result = kEventClassMouse;")))
(constant kEventClassKeyboard ((c-function () OSType "___result = kEventClassKeyboard;")))


;;;
;;;; Control Events
;;;


(constant kEventControlDraw 4)
(constant kEventControlBoundsChanged 154)


;;;
;;;; Window Events
;;;


(constant kEventMouseDown  1)
(constant kEventMouseUp    2)
(constant kEventMouseMoved 5)

(constant kEventRawKeyDown 1)

(constant kEventWindowUpdate  1)
(constant kEventWindowShowing 22)
(constant kEventWindowClose   72)
(constant kEventWindowBoundsChanged 27)


;;;
;;;; WindowRegionCode
;;;


(constant kWindowTitleBarRgn  0)
(constant kWindowStructureRgn 32)
(constant kWindowContentRgn   33)


;;;
;;;; HIObject Classes
;;;


(constant kHIViewClassID ((c-function () CFStringRef "___result_voidstar = kHIViewClassID;")))


;;;
;;;; Event Modifiers
;;;


(constant activeFlagBit 0)


;;;
;;;; Event Errors
;;;


(constant eventNotHandledErr -9874)


;;;
;;;; Modifiers Bits
;;;


(constant cmdKeyBit     8)
(constant shiftKeyBit   9)
(constant optionKeyBit  11)
(constant controlKeyBit 12)


;;;
;;;; HIView Z Order
;;;


(constant kHIViewZOrderAbove 1)
(constant kHIViewZOrderBelow 2)


;;;
;;;; HIView features
;;;


(constant kHIViewFeatureAllowsSubviews 2)


;;;
;;;; Functions
;;;


(c-external OSStatus (SetUserFocusWindow WindowRef))
(c-external void (ShowWindow WindowRef))
(c-external void (HideWindow WindowRef))
(c-external OSStatus (MoveWindowStructure WindowRef short short))
(c-external void (RunApplicationEventLoop))
(c-external void (QuitApplicationEventLoop))
(c-external EventKind  (GetEventKind EventRef))
(c-external OSType (GetEventClass EventRef))
(c-external HIViewRef (HIViewGetRoot WindowRef))
(c-external OSStatus  (HIViewAddSubview HIViewRef HIViewRef))
(c-external OSStatus  (HIViewSetVisible HIViewRef Bool))
(c-external void      (HIViewSetNeedsDisplay HIViewRef Bool))
(c-external OSStatus  (HIViewPlaceInSuperviewAt HIViewRef float float))
(c-external OSStatus  (MoveWindowStructure WindowRef short short))
(c-external UInt32    (GetCurrentEventKeyModifiers))
(c-external HIViewRef (HIViewGetSuperview HIViewRef))
(c-external OSStatus  (HIViewRemoveFromSuperview HIViewRef))
(c-external HIViewRef (HIViewGetFirstSubview HIViewRef))
(c-external OSStatus  (HIViewSetZOrder HIViewRef HIViewZOrderOp HIViewRef))
(c-external void      (BringToFront WindowRef))
(c-external WindowRef (HIViewGetWindow HIViewRef))
(c-external OSStatus  (HIViewSetActivated HIViewRef Bool))
(c-external HIViewRef (HIViewGetFirstSubview HIViewRef))
(c-external OSStatus  (HIViewChangeFeatures HIViewRef HIViewFeatures HIViewFeatures))
(c-external Bool      (HIViewIsValid HIViewRef))
(c-external OSStatus  (ActivateWindow WindowRef Bool))
(c-external void      (BringToFront WindowRef))
(c-external void      (SendBehind WindowRef WindowRef))
(c-external void      (SelectWindow WindowRef))


(definition makeFrontProcess
  (c-function () void
    "ProcessSerialNumber psn = { 0, kCurrentProcess }; 
     OSErr err = SetFrontProcess( & psn );"))


(definition (HIWindowGetAvailablePositioningBounds)
  (let* ((bounds ((c-function () CGRect*
            "CGRect *bounds = malloc(sizeof(CGRect));
                     HIWindowGetAvailablePositioningBounds( kCGNullDirectDisplay, kHICoordSpace72DPIGlobal, bounds );
                     ___result_voidstar = bounds;")))
 (x (CGPoint-x-ref (CGRect-origin-ref bounds)))
 (y (CGPoint-y-ref (CGRect-origin-ref bounds)))
 (w (CGSize-width-ref (CGRect-size-ref bounds)))
 (h (CGSize-height-ref (CGRect-size-ref bounds))))
    (CGRect-free bounds)
    (values x y w h)))
    

(definition (convertPointToGlobal sourceWindow x y)
  (let* ((pt ((c-function (WindowRef float float) CGPoint*
        "HIPoint *pt = malloc(sizeof(HIPoint));
                 pt->x = ___arg2;
                 pt->y = ___arg3;
                 HIPointConvert( pt, kHICoordSpaceWindow, ___arg1, kHICoordSpace72DPIGlobal, NULL );
                 ___result_voidstar = pt;") sourceWindow (exact->inexact x) (exact->inexact y)))
 (x (CGPoint-x-ref pt))
 (y (CGPoint-y-ref pt)))
    (CGPoint-free pt)
    (values x y)))
                 


(definition (convertCoordinates sourceView destView x y)
  (let* ((pt ((c-function (HIViewRef HIViewRef float float) CGPoint*
        "HIPoint *pt = malloc(sizeof(HIPoint));
                 pt->x = ___arg3;
                 pt->y = ___arg4;
                 HIViewConvertPoint (pt, ___arg1, ___arg2);
                 ___result_voidstar = pt;") sourceView destView x y))
 (x (CGPoint-x-ref pt))
 (y (CGPoint-y-ref pt)))
    (CGPoint-free pt)
    (values x y)))


(definition eventWindowRef
  (c-function (EventRef) WindowRef
     "WindowRef ref = NULL;
      GetEventParameter( ___arg1, kEventParamWindowRef, typeWindowRef, NULL, sizeof(WindowRef), NULL, &ref);
      ___result_voidstar = ref;"))


(definition eventKeyCode
  (c-function (EventRef) UInt32
    "UInt32 key;
     GetEventParameter(___arg1, kEventParamKeyCode, typeUInt32, NULL, sizeof(key), NULL, &key);
     ___result = key;"))


(definition eventKeyChar
  (c-function (EventRef) char
    "char ch;
     GetEventParameter(___arg1, kEventParamKeyMacCharCodes, typeChar, NULL, sizeof(ch), NULL, &ch);
     ___result = ch;"))


(definition eventKeyUnicode
  (c-function (EventRef) UniChar
    "UniChar ch;
     GetEventParameter(___arg1, kEventParamKeyUnicodes, typeUnicodeText, NULL, sizeof(ch), NULL, &ch);
     ___result = ch;"))


(definition eventKeyboardType
  (c-function (EventRef) UInt32
    "UInt32 type;
     GetEventParameter(___arg1, kEventParamKeyboardType, typeUInt32, NULL, sizeof(type), NULL, &type);
     ___result = type;"))


(definition eventKeyMods
  (c-function (EventRef) UInt32
    "UInt32 mods;
     GetEventParameter(___arg1, kEventParamKeyModifiers, typeUInt32, NULL, sizeof(mods), NULL, &mods);
     ___result = mods;"))


(definition unmodifiedKey
  (c-function (UInt16 UInt32 UInt32) UniChar
    "UniChar ch;
     UCKeyboardLayout *layout;
     KeyboardLayoutRef layoutRef;
     UInt32 dummy = 0;
     KLGetCurrentKeyboardLayout (&layoutRef);
     KLGetKeyboardLayoutProperty (layoutRef, kKLuchrData, (const void**)&layout);
     UCKeyTranslate(layout, ___arg1, kUCKeyActionDisplay, (___arg3 & ~controlKey & ~optionKey) >> 8,
                    ___arg2, kUCKeyTranslateNoDeadKeysMask, &dummy, 1, &dummy, &ch);
     ___result = ch;"))


(definition (eventMouseLocation ev)
  (let* ((pt ((c-function (EventRef) CGPoint*
                "HIPoint *pt = malloc(sizeof(HIPoint));
                 GetEventParameter( ___arg1, kEventParamWindowMouseLocation, typeHIPoint, NULL, sizeof(HIPoint), NULL, pt);
                 ___result_voidstar = pt;") ev))
 (x (CGPoint-x-ref pt))
 (y (CGPoint-y-ref pt)))
    (CGPoint-free pt)
    (values x y)))


(definition HIViewForPoint
  (c-function (WindowRef float float) HIViewRef
    "HIViewRef res = NULL;
     const HIPoint pt = {___arg2, ___arg3};
     HIViewGetSubviewHit (HIViewGetRoot( ___arg1 ), &pt, 1, &res);
     ___result_voidstar = res;"))


(definition HIViewGetContent
  (c-function (WindowRef) HIViewRef
     "HIViewRef content = NULL;
      HIViewFindByID( HIViewGetRoot( ___arg1 ), kHIViewWindowContentID, &content );
      ___result_voidstar = content;"))


(definition HIViewSetFrame
  (c-function (HIViewRef double double double double) OSStatus
     "HIRect rect = { {___arg2, ___arg3}, {___arg4, ___arg5}};
      ___result = HIViewSetFrame(___arg1, &rect);"))


(definition WindowSetBounds
  (c-function (WindowRef WindowRegionCode short short short short) OSStatus
      "Rect rect = { ___arg4, ___arg3, ___arg4+___arg6, ___arg3+___arg5 };
       ___result = SetWindowBounds(___arg1, ___arg2, &rect);"))


(definition (WindowGetBounds window region)
  (let* ((carbon-rect ((c-function (WindowRef WindowRegionCode) Rect*
                          "Rect *rect = malloc(sizeof(Rect));
                           GetWindowBounds( ___arg1, ___arg2, rect );
                           ___result_voidstar = rect;")
                       window region))
	 (left (Rect-left-ref carbon-rect))
	 (top  (Rect-top-ref carbon-rect))
	 (width (- (Rect-right-ref carbon-rect) left))
	 (height (- (Rect-bottom-ref carbon-rect) top)))
    (Rect-free carbon-rect)
    (values left top width height)))


(definition (HIViewGetFrame view)
  (let* ((carbon-rect ((c-function (HIViewRef) CGRect*
                          "HIRect *rect = malloc(sizeof(HIRect));
                           HIViewGetFrame( ___arg1, rect );
                           ___result_voidstar = rect;")
                       view))
 (left (CGPoint-x-ref (CGRect-origin-ref carbon-rect)))
 (top  (CGPoint-y-ref (CGRect-origin-ref carbon-rect)))
 (width (CGSize-width-ref (CGRect-size-ref carbon-rect)))
 (height (CGSize-height-ref (CGRect-size-ref carbon-rect))))
    (CGRect-free carbon-rect)
    (values left top width height)))


(definition (HIViewGetBounds view)
  (let* ((carbon-rect ((c-function (HIViewRef) CGRect*
                          "CGRect *rect = malloc(sizeof(CGRect));
                           HIViewGetBounds( ___arg1, rect );
                           ___result_voidstar = rect;")
                       view))
 (left (CGPoint-x-ref (CGRect-origin-ref carbon-rect)))
 (top  (CGPoint-y-ref (CGRect-origin-ref carbon-rect)))
 (width (CGSize-width-ref (CGRect-size-ref carbon-rect)))
 (height (CGSize-height-ref (CGRect-size-ref carbon-rect))))
    (CGRect-free carbon-rect)
    (values left top width height)))


(definition void*->HIViewRef
  (c-function (void*) HIViewRef
     "___result_voidstar = (HIViewRef)___arg1;"))


(definition TransformProcessType
  (c-function () OSStatus
    "ProcessSerialNumber psn = { 0, kCurrentProcess };
    ___result = TransformProcessType( &psn, kProcessTransformToForegroundApplication);"))


(definition CreateNewWindow 
  (c-function (WindowClass WindowAttributes short short short short) WindowRef
      "WindowRef ret;
       Rect bounds;
       bounds.top = ___arg3;
       bounds.left = ___arg4;
       bounds.bottom = ___arg5;
       bounds.right = ___arg6;
       CreateNewWindow (___arg1,___arg2,&bounds,&ret);
       ___result_voidstar = ret;"))


(definition HIViewCreate
  (c-function () HIViewRef
     "HIObjectRef obj;
      HIObjectCreate( kHIViewClassID, NULL, &obj );
      ___result_voidstar = (HIViewRef)obj;"))


(definition EventCGContext
  (c-function (EventRef) CGContextRef
     "CGContextRef ref;
      GetEventParameter( ___arg1, kEventParamCGContextRef, typeCGContextRef, NULL, sizeof(CGContextRef), NULL, &ref );
      ___result_voidstar = ref;"))

(definition process-window-message
  #f)

(definition process-control-message
  #f)

(definition public (set-process-window-message proc)
  (set! process-window-message proc))


(definition public (set-process-control-message proc)
  (set! process-control-message proc))


(c-definition (call-process-window-message myHandler theEvent userdata) (EventHandlerCallRef EventRef void*) OSStatus "call_process_window_message" ""
   (process-window-message myHandler theEvent userdata))


(c-definition (call-process-control-message myHandler theEvent userdata) (EventHandlerCallRef EventRef void*) OSStatus "call_process_control_message" ""
   (process-control-message myHandler theEvent userdata))


(definition InstallControlEventHandler
  (c-function (ControlRef) OSStatus
    "EventTypeSpec standard[] = {
       {kEventClassControl, kEventControlDraw},
       {kEventClassControl, kEventControlBoundsChanged},
       {kEventClassControl, kEventControlInvalidateForSizeChange},
       {kEventClassControl, kEventControlApplyBackground}
     };

     ___result = InstallControlEventHandler( ___arg1, NewEventHandlerUPP(call_process_control_message), GetEventTypeCount(standard), standard, ___arg1, NULL);"))


(definition InstallWindowEventHandler
  (c-function (WindowRef) OSStatus
     "EventTypeSpec standard[] = {
         {kEventClassWindow,   kEventWindowClose},
         {kEventClassWindow,   kEventWindowBoundsChanged},
         {kEventClassMouse,    kEventMouseMoved},
         {kEventClassMouse,    kEventMouseDown},
         {kEventClassMouse,    kEventMouseUp},
         {kEventClassKeyboard, kEventRawKeyDown}
      };

      ___result = InstallWindowEventHandler( ___arg1, NewEventHandlerUPP(call_process_window_message), GetEventTypeCount(standard), standard, ___arg1, NULL );"))


(definition DestroyWindow
  (c-function (WindowRef) void
     "CFRelease(___arg1);"))


(definition DestroyView
  (c-function (HIViewRef) void
     "CFRelease(___arg1);"))


(definition (relinquish-process))


(TransformProcessType))

